<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Subrogation Wizard</title>
<style>
  :root{--bg:#ffffff;--fg:#111;--muted:#666;--brand:#0b5;--warn:#b00;--card:#f6f7f8;--btn:#111;--btnfg:#fff;}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0;padding:16px}
  .app{max-width:720px;margin:0 auto}
  .card{background:var(--card);border-radius:14px;padding:18px 16px;margin:10px 0;box-shadow:0 1px 2px rgba(0,0,0,.05)}
  h1{font-size:20px;margin:0 0 8px}
  h2{font-size:16px;margin:0 0 8px;color:var(--muted)}
  .q{font-size:16px;margin:6px 0 12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  select,input[type=number]{padding:10px;border:1px solid #ddd;border-radius:10px;font-size:16px;background:#fff;min-width:220px}
  .btn{padding:10px 14px;border-radius:10px;border:0;background:var(--btn);color:var(--btnfg);cursor:pointer;font-size:15px}
  .btn.secondary{background:#ddd;color:#111}
  .btn.yes{background:var(--brand)}
  .btn.no{background:#444}
  .btn.warn{background:var(--warn);color:#fff}
  .hint{color:var(--muted);font-size:13px;margin-top:6px}
  .out{white-space:pre-wrap;line-height:1.35}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#e8f8ef;color:#0a5;margin:4px 0;font-weight:600}
  .pill.red{background:#fde8e8;color:#b00}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .spacer{height:6px}
</style>
</head>
<body>
<div class="app">
  <div class="card">
    <h1>Subrogation Screening & Reserve Wizard</h1>
    <h2>One question at a time. Buttons for Yes/No. State as dropdown. Works embedded in Notion.</h2>
  </div>

  <div class="card" id="stage"></div>
  <div class="card" id="log" style="display:none"></div>
</div>

<script>
const STATE_RULES = {
  "AL":"pure_contrib","MD":"pure_contrib","NC":"pure_contrib","VA":"pure_contrib","DC":"pure_contrib",
  "AZ":"pure_comparative","CA":"pure_comparative","FL":"pure_comparative","NY":"pure_comparative","WA":"pure_comparative","NM":"pure_comparative","KY":"pure_comparative",
  "CO":"modified_50","GA":"modified_50","NV":"modified_50","ND":"modified_50","UT":"modified_50","KS":"modified_50",
  "IL":"modified_51","MI":"modified_51","NJ":"modified_51","PA":"modified_51","MN":"modified_51","MA":"modified_51","OK":"modified_51","OR":"modified_51","TX":"modified_51"
};
const ALL_STATES = [
"AL","AK","AZ","AR","CA","CO","CT","DE","DC","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME",
"MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI",
"SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"
];
function getRegime(st){ return STATE_RULES[st] || "modified_51"; }
function compOk(regime, ourFault, adverseFault){
  switch(regime){
    case "pure_comparative": return adverseFault > 0;
    case "modified_50": return ourFault < 50 && adverseFault > 0;
    case "modified_51": return ourFault <= 50 && adverseFault > 0;
    case "pure_contrib": return ourFault === 0 && adverseFault > 0;
    default: return adverseFault > 0;
  }
}

const stage = document.getElementById("stage");
let ctx = {};
let restartTimer = null;
let reminderTimer = null;
function clearTimers(){ if(restartTimer){clearTimeout(restartTimer);restartTimer=null;} if(reminderTimer){clearTimeout(reminderTimer);reminderTimer=null;} }
function render(html){ stage.innerHTML = html; }
function btn(label, cls, onclick){ return `<button class="btn ${cls||''}" onclick="${onclick}">${label}</button>`; }
function diaryDatePlusDays(days){
  const now = new Date();
  const target = new Date(now.getTime() + days*24*60*60*1000);
  const fmt = new Intl.DateTimeFormat('en-US', { timeZone: 'America/Phoenix', year:'numeric', month:'long', day:'2-digit' });
  return fmt.format(target);
}

function start(){ clearTimers(); ctx = {}; renderStateQuestion(); }
function renderStateQuestion(){
  const opts = ALL_STATES.map(s=>`<option value="${s}">${s}</option>`).join("");
  render(`
    <div class="q"><strong>What state did the loss occur in?</strong></div>
    <div class="row">
      <select id="stateSel"><option value="" disabled selected>Select state</option>${opts}</select>
      ${btn('Next','yes','onStateNext()')}
    </div>
    <div class="hint">Choose the state from the dropdown.</div>
  `);
}
window.onStateNext = function(){
  const sel = document.getElementById('stateSel');
  if(!sel.value) return;
  ctx.state = sel.value;
  renderOurFault();
};
function renderOurFault(){
  render(`
    <div class="q"><strong>What is our at fault percentage?</strong></div>
    <div class="row">
      <input id="ourFault" type="number" min="0" max="100" step="1" placeholder="0–100">
      ${btn('Next','yes','onOurFaultNext()')}
    </div>
  `);
}
window.onOurFaultNext = function(){
  const v = Number(document.getElementById('ourFault').value);
  if(isNaN(v) || v<0 || v>100) return;
  ctx.ourFault = Math.round(v);
  renderAdverseFault();
};
function renderAdverseFault(){
  const suggested = 100 - (ctx.ourFault||0);
  render(`
    <div class="q"><strong>What is the 3rd party's at fault percentage?</strong></div>
    <div class="row">
      <input id="advFault" type="number" min="0" max="100" step="1" placeholder="0–100" value="${Math.max(0,Math.min(100,suggested))}">
      ${btn('Next','yes','onAdverseFaultNext()')}
    </div>
  `);
}
window.onAdverseFaultNext = function(){
  const v = Number(document.getElementById('advFault').value);
  if(isNaN(v) || v<0 || v>100) return;
  ctx.adverseFault = Math.round(v);
  const regime = getRegime(ctx.state);
  if(!compOk(regime, ctx.ourFault, ctx.adverseFault)){
    render(`
      <div class="pill red">No subrogation potential found</div>
      <div class="spacer"></div>
      ${btn('Start over','secondary','start()')}
    `);
    return;
  }
  renderCopartGate();
};
function renderCopartGate(){
  render(`
    <div class="pill">Subrogation potential found</div>
    <div class="q">Has Copart been finalized and paid/recoveries received?</div>
    <div class="row">
      ${btn('Yes','yes','onCopartYes()')}
      ${btn('No','no','onCopartNo()')}
    </div>
  `);
}
window.onCopartNo = function(){
  render(`
    <div class="out">Add potential subro tag to claim details page and monitor Copart until completion.</div>
    <div class="spacer"></div>
    ${btn('Start over','secondary','start()')}
  `);
};
window.onCopartYes = function(){
  render(`
    <div class="out">Congratulations, you are ready to pursue subrogation. Please initiate the start subrogation workflow task. You do not need to reassign it, change the date, or mark it complete; it will automatically complete itself.</div>
    <div class="q" style="margin-top:10px;">Did you start the workflow task?</div>
    <div class="row">
      ${btn('Yes','yes','onWorkflowStarted()')}
      ${btn('No','no','onWorkflowNotStarted()')}
    </div>
  `);
};
window.onWorkflowNotStarted = function(){
  render(`
    <div class="out">Please start the task in order to move on.</div>
    <div class="row" style="margin-top:8px;">
      ${btn('I started it','yes','onWorkflowStarted()')}
      ${btn('Start over','secondary','start()')}
    </div>
  `);
};
window.onWorkflowStarted = function(){
  render(`
    <div class="out">Add the <strong>active subrogation</strong> tag to the claim details page and remove the <strong>potential subro</strong> tag.</div>
    <div class="q" style="margin-top:10px;">Have you added this tag?</div>
    <div class="row">
      ${btn('Yes','yes','onTagsAdded()')}
      ${btn('No','no','onTagsMissing()')}
    </div>
  `);
};
window.onTagsMissing = function(){
  render(`
    <div class="out">Please add the appropriate tags.</div>
    <div class="row" style="margin-top:8px;">
      ${btn('Tags added','yes','onTagsAdded()')}
      ${btn('Start over','secondary','start()')}
    </div>
  `);
};
window.onTagsAdded = function(){
  render(`
    <div class="out"><strong>Great, you are ready to add reserves now.</strong> I will ask you a series of questions to advise you how much to set the recovery reserves for.</div>
    <div class="row" style="margin-top:10px;">
      ${btn('Continue','yes','askSettlement()')}
    </div>
  `);
};
function askSettlement(){
  render(`
    <div class="q"><strong>How much was the total settlement?</strong></div>
    <div class="row">
      <input id="settlement" type="number" step="0.01" min="0" placeholder="USD">
      ${btn('Next','yes','onSettlement()')}
    </div>
  `);
}
window.onSettlement = function(){
  const v = Number(document.getElementById('settlement').value);
  if(isNaN(v) || v<0) return;
  ctx.totalSettlement = v;
  askDeductible();
};
function askDeductible(){
  render(`
    <div class="q"><strong>How much was the deductible?</strong></div>
    <div class="row">
      <input id="ded" type="number" step="0.01" min="0" placeholder="USD">
      ${btn('Next','yes','onDeductible()')}
    </div>
  `);
}
window.onDeductible = function(){
  const v = Number(document.getElementById('ded').value);
  if(isNaN(v) || v<0) return;
  ctx.deductible = v;
  askTow();
};
function askTow(){
  render(`
    <div class="q"><strong>How much did we pay the 1st party for towing reimbursement?</strong></div>
    <div class="row">
      <input id="tow" type="number" step="0.01" min="0" placeholder="USD">
      ${btn('Next','yes','onTow()')}
    </div>
  `);
}
window.onTow = function(){
  const v = Number(document.getElementById('tow').value);
  if(isNaN(v) || v<0) return;
  ctx.tow = v;
  askChildSeat();
};
function askChildSeat(){
  render(`
    <div class="q"><strong>How much was paid for child safety seat reimbursement?</strong></div>
    <div class="row">
      <input id="css" type="number" step="0.01" min="0" placeholder="USD">
      ${btn('Next','yes','onChildSeat()')}
    </div>
  `);
}
window.onChildSeat = function(){
  const v = Number(document.getElementById('css').value);
  if(isNaN(v) || v<0) return;
  ctx.childSeat = v;
  askLossOfUse();
};
function askLossOfUse(){
  render(`
    <div class="q"><strong>How much did we pay for loss of use?</strong></div>
    <div class="row">
      <input id="lou" type="number" step="0.01" min="0" placeholder="USD">
      ${btn('Next','yes','onLossOfUse()')}
    </div>
  `);
}
window.onLossOfUse = function(){
  const v = Number(document.getElementById('lou').value);
  if(isNaN(v) || v<0) return;
  ctx.lossOfUse = v;
  askRental();
};
function askRental(){
  render(`
    <div class="q"><strong>How much did we pay for the rental car?</strong></div>
    <div class="row">
      <input id="rental" type="number" step="0.01" min="0" placeholder="USD">
      ${btn('Next','yes','onRental()')}
    </div>
  `);
}
window.onRental = function(){
  const v = Number(document.getElementById('rental').value);
  if(isNaN(v) || v<0) return;
  ctx.rental = v;
  askCopartCharges();
};
function askCopartCharges(){
  render(`
    <div class="q"><strong>How much were the Copart charges?</strong></div>
    <div class="row">
      <input id="copart" type="number" step="0.01" min="0" placeholder="USD">
      ${btn('Next','yes','onCopart()')}
    </div>
  `);
}
window.onCopart = function(){
  const v = Number(document.getElementById('copart').value);
  if(isNaN(v) || v<0) return;
  ctx.copart = v;
  askCopartAdv();
};
function askCopartAdv(){
  render(`
    <div class="q"><strong>How much were the Copart advance charges?</strong></div>
    <div class="row">
      <input id="copartAdv" type="number" step="0.01" min="0" placeholder="USD">
      ${btn('Next','yes','onCopartAdv()')}
    </div>
  `);
}
window.onCopartAdv = function(){
  const v = Number(document.getElementById('copartAdv').value);
  if(isNaN(v) || v<0) return;
  ctx.copartAdv = v;
  askSalvageSale();
};
function askSalvageSale(){
  render(`
    <div class="q"><strong>How much was the salvage sale price of the vehicle?</strong></div>
    <div class="row">
      <input id="salvage" type="number" step="0.01" min="0" placeholder="USD">
      ${btn('Calculate','yes','onSalvage()')}
    </div>
  `);
}
window.onSalvage = function(){
  const v = Number(document.getElementById('salvage').value);
  if(isNaN(v) || v<0) return;
  ctx.salvageSale = v;
  computeReserve();
};
function computeReserve(){
  const sum = (ctx.totalSettlement||0) + (ctx.deductible||0) + (ctx.tow||0) + (ctx.childSeat||0) + (ctx.lossOfUse||0) + (ctx.rental||0) + (ctx.copart||0) + (ctx.copartAdv||0) - (ctx.salvageSale||0);
  const pct = (ctx.adverseFault||0) / 100.0;
  const reserve = Math.max(0, sum * pct);
  ctx.reserve = Math.round(reserve*100)/100;
  const diary = diaryDatePlusDays(14);
  render(`
    <div class="out">
      <div><strong>Salvage Recovery Reserves</strong> = (Total settlement + Deductible + Towing + Child seat + Loss of use + Rental car + Copart charges + Copart advance charges − Salvage sale price) × Third-party fault %</div>
      <div class="mono" style="margin-top:6px;">
        = (${(ctx.totalSettlement||0).toFixed(2)} + ${(ctx.deductible||0).toFixed(2)} + ${(ctx.tow||0).toFixed(2)} + ${(ctx.childSeat||0).toFixed(2)} + ${(ctx.lossOfUse||0).toFixed(2)} + ${(ctx.rental||0).toFixed(2)} + ${(ctx.copart||0).toFixed(2)} + ${(ctx.copartAdv||0).toFixed(2)} − ${(ctx.salvageSale||0).toFixed(2)}) × ${(ctx.adverseFault||0)}%
      </div>
      <div class="q" style="margin-top:8px;"><strong>Total Salvage Recovery Reserves:</strong> $${ctx.reserve.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}</div>
      <div class="hint">Set recovery reserves by selecting <strong>Recovery Reserves</strong>, the correct vehicle exposure, then choose <strong>Claim → Vehicle Damage → Subrogation</strong> and add the reserves.</div>
      <div class="q" style="margin-top:8px;">Set a diary to monitor subrogation status in 14 days: <strong>${diary}</strong></div>
    </div>
    <div class="q" style="margin-top:10px;">Do you want to start over with another claim?</div>
    <div class="row">
      ${btn('Yes','yes','start()')}
      ${btn('No','no','onDeclineRestart()')}
    </div>
  `);
}
window.onDeclineRestart = function(){
  clearTimers();
  const remind = () => {
    render(`
      <div class="out">Reminder: Start over with another claim?</div>
      <div class="row" style="margin-top:8px;">
        ${btn('Start over now','yes','start()')}
        ${btn('Not yet','no','onStillWorking()')}
      </div>
    `);
    restartTimer = setTimeout(()=>start(), 5*60*1000);
  };
  reminderTimer = setTimeout(remind, 5*60*1000);
};
window.onStillWorking = function(){
  clearTimers();
  reminderTimer = setTimeout(()=>{ window.onDeclineRestart(); }, 5*60*1000);
};
start();
</script>
</body>
</html>
